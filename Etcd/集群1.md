[TOC]



## 集群预览

```shell
# 集群成员
$ etcdctl -w=table --endpoints=172.16.1.1:2379 member list
+------------+---------+--------+-------------------+-------------------+------------+
|  ID        | STATUS  |  NAME  | PEER ADDRS        | CLIENT ADDRS      | IS LEARNER |
+------------+---------+--------+-------------------+-------------------+------------+
| ca64b0c812 | started | node01 | 172.16.1.1:2380   | 172.16.1.1:2379   |    false   |
| 838e911415 | started | node02 | 172.16.1.2:2380   | 172.16.1.2:2379   |    false   |
| 9c985eb081 | started | node03 | 172.16.1.3:2380   | 172.16.1.3:2379   |    false   |
+------------+---------+--------+-------------------+-------------------+------------+
```

```shell
# 集群状态
$ ENDPOINTS=172.16.1.1:2379,172.16.1.2:2379,172.16.1.3:2379
$ etcdctl -w table --endpoints=$ENDPOINTS endpoint status

+-----------------+------------------+---------+---------+-----------+------------+-...-+--------+
|    ENDPOINT     |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | ... | ERRORS |
+-----------------+------------------+---------+---------+-----------+------------+-...-+--------+
| 172.16.1.1:2379 | 2c95638865e607fb |  3.5.12 |   20 kB |      true |      false | ... |        |
| 172.16.1.2:2379 | 1ba24f0f2b33f41a |  3.5.12 |   20 kB |     false |      false | ... |        |
| 172.16.1.3:2379 | 8a6b28428abc283f |  3.5.12 |   20 kB |     false |      false | ... |        |
+-----------------+------------------+---------+---------+-----------+------------+-...-+--------+
```

```shell
# 读写数据
etcdctl --endpoints=172.16.1.1:2379 put greet HelloWorld
etcdctl --endpoints=172.16.1.1:2380 get greet
```






## 搭建集群
> 可参考[官方实例](https://etcd.io/docs/v3.4.0/demo/) 。

> 除了命令行启动参数之外，也可以使用配置文件方式启动服务，具体可参考官方[Ymal配置示例](https://github.com/etcd-io/etcd/blob/master/etcd.conf.yml.sample) 。
>
> 此外，还可以设置[Etcd相关的系统环境变量](https://etcd.io/docs/v3.4.0/op-guide/configuration/)，优先级：`配置文件参数 > 命令行参数 > 系统环境变量`。
>
**创建配置文件：**

```shell
# 分别创建配置文件
vim /etc/etcd/config.yaml
```

```yaml
# etcd节点的名称
name: node01
# etcd数据目录
data-dir: /opt/etcd
# 宣传给客户端的URL
advertise-client-urls: http://172.16.1.1:2379
# 监听的客户端访问URL
listen-client-urls: http://0.0.0.0:2379
# 初始广告的对等节点URL
initial-advertise-peer-urls: http://172.16.1.1:2380
# 监听的对等节点URL
listen-peer-urls: http://0.0.0.0:2380
# 初始集群状态
initial-cluster-state: new
# 初始集群令牌
initial-cluster-token: my-etcd-cluster

# 集群发现(任选其一)
# 方法1：手动发现服务
initial-cluster: node01=http://172.16.1.1:2380,node02=http://172.16.1.2:2380,node03=http://172.16.1.3:2380

# 方式2：动态发现服务(curl -sl https://discovery.etcd.io/new?size=3)：
#discovery: https://discovery.etcd.io/xxxxxx

# 方式3：动态的启动参数(见启动服务)
```

```yaml
name: node02
data-dir: /opt/etcd
advertise-client-urls: http://172.16.1.2:2379
listen-client-urls: http://0.0.0.0:2379
initial-advertise-peer-urls: http://172.16.1.2:2380
listen-peer-urls: http://0.0.0.0:2380
initial-cluster-state: new
initial-cluster-token: my-etcd-cluster
initial-cluster: node01=http://172.16.1.1:2380,node02=http://172.16.1.2:2380,node03=http://172.16.1.3:2380
```

```yaml
name: node03
data-dir: /opt/etcd
advertise-client-urls: http://172.16.1.3:2379
listen-client-urls: http://0.0.0.0:2379
initial-advertise-peer-urls: http://172.16.1.3:2380
listen-peer-urls: http://0.0.0.0:2380
initial-cluster-state: new
initial-cluster-token: my-etcd-cluster
initial-cluster: node01=http://172.16.1.1:2380,node02=http://172.16.1.2:2380,node03=http://172.16.1.3:2380
```

**启动服务：**

```shell
# 分别启动各服务
cd /opt/etcd
sudo nohup etcd --config-file=/etc/etcd/config.yaml 2>&1 &

# 或动态发现【推荐】
# export ETCD_DISCOVERY=$(curl -sl https://discovery.etcd.io/new?size=3)
# export ETCD_DISCOVERY=https://discovery.etcd.io/de60d4dc1f3724e7c8dc4ea94000b215
cd /opt/etcd
sudo nohup etcd --discovery=$ETCD_DISCOVERY --config-file=/etc/etcd/config.yaml 2>&1 &
```



使用公共的动态发现

```shell
sudo pkill etcd
sudo rm -rf /opt/etcd/*
ps -ef|grep etcd
etcdctl -w=table --endpoints=172.16.1.1:2379 member list
```






## 集群伸缩

**1. 增加集群节点 **

_**先添加集群成员**_

```shell
# 添加节点（节点名称与集群成员名称一致）
$ etcdctl --endpoints=$ENDPOINTS member add "etcd03" --peer-urls=http://localhost:2580

# 查看集群成员，注意【STATUS】字段
$ etcdctl --endpoints=$ENDPOINTS member list -w table
```

```txt
[root@vm02 etcd]# etcdctl --endpoints=$ENDPOINTS member list -w table
+------------------+-----------+--------+-----------------------+-----------------------+------------+
| ID | STATUS | NAME | PEER ADDRS | CLIENT ADDRS | IS LEARNER |
+------------------+-----------+--------+-----------------------+-----------------------+------------+
| 3949aab25068a95f | unstarted | | http://localhost:2580 | | false |
| 8e9e05c52164694d | started | node02 | http://172.16.1.1:2380 | http://172.16.1.1:2379 | false |
| f228da3d709012fc | started | node03 | http://localhost:2480 | http://localhost:2479 | false |
+------------------+-----------+--------+-----------------------+-----------------------+------------+
```

_**最后扩展集群列表，并启动服务**_

```shell
# 声明集群列表
$ CLUSTERS=node02=http://172.16.1.1:2380,node03=http://localhost:2480,etcd03=http://localhost:2580

# 至于集群状态变为【existing】
$ nohup etcd --name "etcd03" \
--listen-client-urls http://localhost:2579 \
--advertise-client-urls http://localhost:2579 \
--listen-peer-urls http://127.0.0.1:2580 \
--initial-advertise-peer-urls http://localhost:2580 \
--initial-cluster-state existing \
--initial-cluster ${CLUSTERS} \
--initial-cluster-token etcd-cluster-1 \
>./etcd03.log 2>&1 &
```
_**再次查看服务结果：**_

```shell
$ ENDPOINTS=172.16.1.1:2379,localhost:2479,localhost:2579
$ etcdctl --endpoints=$ENDPOINTS member list -w table
$ etcdctl --endpoints=$ENDPOINTS endpoint status -w table
```

**3. 删除集群节点**

```shell
# 试着删除leader节点，会发现leader转移到其他节点上
$ etcdctl --endpoints=$ENDPOINTS member remove 8e9e05c52164694d
```



## 参考链接


> https://etcd.io/docs/v3.4.0/demo/ 官方实例
>
> https://github.com/etcd-io/etcd/blob/master/etcd.conf.yml.sample Ymal配置示例
>
> https://etcd.io/docs/v3.4.0/op-guide/configuration/ 配置说明与环境变量
>
> https://www.jianshu.com/p/667d1111b8c8

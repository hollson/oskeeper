
[toc]


## 一. ETCD简介
[**Etcd**](https://etcd.io)是一个开源的、分布式的键值对数据存储系统，提供共享配置、服务的注册和发现。



## 二. 安装ETCD
 >  Linux、MacOS、Docker安装，参考[官方安装文档](https://github.com/etcd-io/etcd/releases) 。






## 启动Etcd服务：

```shell
# 启动Etcd服务
etcd --listen-client-urls=http://localhost:2379,http://localhost:4001 \
--advertise-client-urls=http://localhost:2379,http://localhost:4001 \
--data-dir=/opt/etcd/data \
--log-output=/opt/etcd/logs/etcd.log \
--config-file=/opt/etcd/config/etcd.conf
```

## 基本命令

```shell
# 健康检查
etcdctl endpoint health

# 成员列表
etcdctl member list

# 设置键值对
etcdctl put hello HelloWorld

# 获取键值
etcdctl get hello

# 递归获取所有键值对
etcdctl get --prefix key

# 删除指定键
etcdctl del key

# 数据备份
etcdctl snapshot save /opt/etcd/backup.db


# 客户端测试
etcdctl --endpoints=localhost:2379 put hello world
etcdctl --endpoints=localhost:2379 get hello
curl 0.0.0.0:2379/version
```










## Http接口



### 版本信息

```shell
# 版本信息
curl http://127.0.0.1:2379/version

curl -X PUT http://127.0.0.1:2379/v3/keys/message value=="hello, etcd"

curl -X GET http://127.0.0.1:2379/v3/keys/message

curl -X DELETE http://127.0.0.1:2379/v2/keys/message

```



1. 设置键值对：
```shell
# 设置键值对
curl -X PUT http://localhost:2379/v3/kv/keys/key1 -d value=123

# 获取指定键的值
curl http://localhost:2379/v3/kv/keys/key1

# 删除
curl -X DELETE http://localhost:2379/v3/kv/keys/key1

# 设置键值对并设置 TTL（以秒为单位）：
curl -X POST http://localhost:2379/v3/kv/lease -d '{"key": "key1", "value": "123", "lease": 10}'

# 获取具有指定前缀的所有键值对：
curl http://localhost:2379/v3/kv/range?key=key_prefix

# 监听指定键的变化：
curl http://localhost:2379/v3/watch -X POST -d '{"create_request": {"key": "/keys/key1"}}'

# 创建目录
curl -X PUT http://localhost:2379/v3/kv/keys/directory -d dir=true

# 监听目录

# 删除目录(及子内容)
curl -X DELETE http://localhost:2379/v3/kv/range?prefix=directory/


# 设置有序键
curl -X POST http://localhost:2379/v3/kv/lease -d '{"key": "ordered", "value": "value1", "lease": 0, "lease_options": {"withPrevKV": true}}'

# 获取范围内的有序键
curl http://localhost:2379/v3/kv/range?type=range&start=ordered/a&end=ordered/z
```

**集群操作**

```shell
# 获取成员列表：
curl http://localhost:2379/v3/members

# 添加成员
curl -X POST http://localhost:2379/v3/member/add -d '{"peerURLs":["http://<new_member_host>:2380"]}'

# 删除成员
curl -X POST http://localhost:2379/v3/member/remove -d '{"memberID":"<member_id>"}'
```



10. 原子操作（事务）：
```shell
curl -X POST http://localhost:2379/v3/kv/txn -d '{
    "success": [
        {"request_put": {"key": "key1", "value": "123"}},
        {"compare_and_swap": {"key": "key2", "prev_kv": true, "value": "456"}}
    ],
    "failure": [
        {"request_range": {"key": "nonexistent"}}
    ]
}'
```



## 5. etcdctl 命令行工具

```shell
# 设置一个 key 的值
etcdctl set /message "hello, etcd"
hello, etcd

# 获取 key 的值
etcdctl get /message
hello, etcd

# 获取 key 的值，包含更详细的元数据
etcdctl -o extended get /message
Key: /message
Created-Index: 1073
Modified-Index: 1073
TTL: 0
Index: 1073

hello, etcd

# 获取不存在 key 的值，会报错
etcdctl get /notexist
Error:  100: Key not found (/notexist) [1048]

# 设置 key 的 ttl，过期后会被自动删除
etcdctl set /tempkey "gone with wind" --ttl 5
gone with wind
etcdctl get /tempkey
gone with wind
etcdctl get /tempkey
Error:  100: Key not found (/tempkey) [1050]

# 如果 key 的值是 "hello, etcd"，就把它替换为 "goodbye, etcd"
etcdctl set --swap-with-value "hello, world" /message "goodbye, etcd"
Error:  101: Compare failed ([hello, world != hello, etcd]) [1050]
etcdctl set --swap-with-value "hello, etcd" /message "goodbye, etcd"
goodbye, etcd

# 仅当 key 不存在的时候创建
etcdctl mk /foo bar
bar
etcdctl mk /foo bar
Error:  105: Key already exists (/foo) [1052]

# 自动创建排序的 key
etcdctl mk --in-order /queue job1
job1
etcdctl mk --in-order /queue job2
job2
etcdctl ls --sort /queue
/queue/00000000000000001053
/queue/00000000000000001054

# 更新 key 的值或者 ttl，只有当 key 已经存在的时候才会生效，否则报错
etcdctl update /message "I'am changed"
I'am changed
etcdctl get /message
I'am changed
etcdctl update /notexist "I'am changed"
Error:  100: Key not found (/notexist) [1055]
etcdctl update --ttl 3 /message "I'am changed"
I'am changed
etcdctl get /message
Error:  100: Key not found (/message) [1057]

# 删除某个 key
etcdctl mk /foo bar
bar
etcdctl rm /foo
PrevNode.Value: bar
etcdctl get /foo
Error:  100: Key not found (/foo) [1062]

# 只有当 key 的值匹配的时候，才进行删除
etcdctl mk /foo bar
bar
etcdctl rm --with-value wrong /foo
Error:  101: Compare failed ([wrong != bar]) [1063]
etcdctl rm --with-value bar /foo

# 创建一个目录
etcdctl mkdir /dir

# 删除空目录
etcdctl mkdir /dir/subdir/
etcdctl rmdir /dir/subdir/

# 删除非空目录
etcdctl rmdir /dir
Error:  108: Directory not empty (/dir) [1071]
etcdctl rm --recursive /dir

# 列出目录的内容
etcdctl ls /
/queue
/anotherdir
/message

# 递归列出目录的内容
etcdctl ls --recursive /
/anotherdir
/message
/queue
/queue/00000000000000001053
/queue/00000000000000001054

# 监听某个 key，当 key 改变的时候会打印出变化
etcdctl watch /message
changed

# 监听某个目录，当目录中任何 node 改变的时候，都会打印出来
etcdctl watch --recursive /
[set] /message
changed

# 一直监听，除非 `CTL + C` 导致退出监听
etcdctl watch --forever /message
new value
chaned again
Wola

# 监听目录，并在发生变化的时候执行一个命令
etcdctl exec-watch --recursive / -- sh -c "echo change detected."
change detected.
change detected.
```











## 用户权限

```shell
# 用户列表
etcdctl user list

# 添加root用户
etcdctl user add root

# 查看用户
etcdctl user get root

# 查看角色
etcdctl role get root

# 开启认证(即需要身份验证才能访问)
etcdctl auth enable

# 开启认证后会多一个guest角色(不能删)
etcdctl --username root:123456 role list

# guest拥有超级权限
etcdctl --username root:123456 role get guest

# 添加自定义用户
etcdctl --username root:123456 user add leader    #领导
etcdctl --username root:123456 user add member    #成员

# 定义角色(conf读写角色)
etcdctl --username root:123456 role add conf100    #只读角色
etcdctl --username root:123456 role add conf110    #读写角色

# 定义角色权限
etcdctl --username root:123456 role grant --read --path /conf/* conf100       #只读权限
etcdctl --username root:123456 role grant --readwrite --path /conf/* conf110  #读写权限

# 给用户赋予角色
etcdctl --username root:123456 user grant --roles conf110 leader
etcdctl --username root:123456 user grant --roles conf100 member

# 测试权限
etcdctl --username member:123456 set /conf/my.ini  root:xxx@127.0.0.1:3306/demo
etcdctl --username leader:123456 set /conf/my.ini  root:xxx@127.0.0.1:3306/demo
etcdctl --username member:123456 get /conf/my.ini
etcdctl --endpoint=192.168.100.214:2379 --username member:123456 get /conf/my.ini
etcdctl --username leader:123456 --endpoints http://192.168.100.214:2379 set /conf/app.yml xxx

# 查看用户权限
etcdctl --username root:123456 user get leader

#关闭认证
etcdctl --username root:123456 auth disable

#删除用户
etcdctl --username root:123456 user remove userx

# 用户撤销角色
etcdctl --username root:123456 user revoke rolex

#修改用户密码
etcdctl --username root:123456 user passwd userx
```


```shell
etcdctl --user=root:123456 user list
etcdctl --user=root:123456 --endpoints=192.168.1.3:2379 put shi 史布斯
```


## 补充
**动态配置**
```shell
# 使用IP作为节点名称
IP=`/sbin/ifconfig -a|grep "inet "|grep "1[9,7]2."|awk '{print $2}'|tail -n 1|tr -d "addr:"`
echo 当前IP:$IP

# 使用md5(IP)作为Etcd的Token
TOKEN=`echo $IP| md5sum | cut -d ' ' -f 1` 
echo $TOKEN
```




https://blog.csdn.net/u010278923/article/details/71727682
https://blog.csdn.net/Sherry_zh2017/article/details/79162344
https://blog.csdn.net/leftwukaixing/article/details/78252691

https://www.e-learn.cn/content/qita/1601591
https://blog.csdn.net/hxpjava1/article/details/78275995

https://godoc.org/go.etcd.io/etcd/clientv3#pkg-index
https://blog.csdn.net/warrior_0319/article/details/80223947

https://www.orchome.com/620

https://blog.51cto.com/liuzhengwei521/2411731?source=dra






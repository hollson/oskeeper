# Tailscaleä½¿ç”¨æŒ‡å—

[TOC]

## ğŸŒ ä¸€. Tailscaleä»‹ç»

**[Tailscale](https://tailscale.com/download)** æ˜¯ä¸€æ¬¾åŸºäº **WireGuard** åè®®çš„é›¶é…ç½®è™šæ‹Ÿç§æœ‰ç½‘ç»œ(VPN)å·¥å…·ï¼Œèƒ½è®©å¤šå°è®¾å¤‡åœ¨äº’è”ç½‘ä¸Šå½¢æˆä¸€ä¸ªåŠ å¯†çš„ç§æœ‰ç½‘ç»œã€‚

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**

- âš¡ï¸ **é›¶é…ç½®**ï¼šåŸºäº WireGuard åè®®ï¼Œå®‰è£…åå³å¯è‡ªåŠ¨å»ºç«‹å®‰å…¨è¿æ¥
- ğŸ” **å®‰å…¨åŠ å¯†**ï¼šæ‰€æœ‰æµé‡é€šè¿‡ç«¯åˆ°ç«¯åŠ å¯†éš§é“ä¼ è¾“
- ğŸŒ **è·¨å¹³å°æ”¯æŒ**ï¼šæ”¯æŒ Windowsã€macOSã€Linuxã€Androidã€iOS ç­‰å¤šç§è®¾å¤‡
- ğŸ  **ç§æœ‰ç½‘ç»œ**ï¼šè®¾å¤‡è·å¾— 100.x.x.x ç§æœ‰ IPï¼Œå¦‚åŒåœ¨åŒä¸€ä¸ªå±€åŸŸç½‘
- ğŸš€ **æ™ºèƒ½è·¯ç”±**ï¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜è·¯å¾„ï¼ˆUDP ç›´è¿æˆ– DERP ä¸­ç»§ï¼‰



**é€‚ç”¨åœºæ™¯ï¼š**
- è®¿é—®å†…ç½‘æœåŠ¡ï¼ˆå¦‚æ•°æ®åº“ã€Web æœåŠ¡ï¼‰
- è¿œç¨‹åŠå…¬è®¿é—®å…¬å¸èµ„æº
- æœåŠ¡å™¨ç®¡ç†ä¸è¿ç»´
- å®‰å…¨è®¿é—®å®¶åº­ç½‘ç»œè®¾å¤‡



<br/>



## ğŸ€ äºŒ. å®‰è£…é…ç½®

### 2.1 å®‰è£…Tailscale

- **1. Linux (Ubuntu/Debian)**ï¼š

```bash
# å®‰è£…å‘½ä»¤
curl -fsSL https://tailscale.com/install.sh | sh

# å¯åŠ¨å¹¶åŠ å…¥ç½‘ç»œï¼ˆæ‰§è¡Œåå¤åˆ¶é“¾æ¥åˆ°æµè§ˆå™¨æ‰“å¼€,ä½¿ç”¨(Googleã€GitHubç­‰è´¦å·ç™»å½•)
sudo tailscale up
```

- **2. Windows/macOS**

ä» [Tailscale å®˜ç½‘](https://tailscale.com/download) ä¸‹è½½å®‰è£…å®¢æˆ·ç«¯, ç™»å½•å¹¶é€‰æ‹©è´¦å·ã€‚



### 2.2 é…ç½®AuthKey

#### 2.2.1 ç”ŸæˆAuthKey

- ç™»å½• [Tailscale æ§åˆ¶å°](https://login.tailscale.com/admin) ï¼Œè¿›å…¥ **Settings** â†’ **Auth keys**ã€‚

- ç‚¹å‡» **Generate one-off key**ï¼ˆä¸€æ¬¡æ€§å¯†é’¥ï¼‰æˆ– **Generate reusable key**ï¼ˆå¯é‡å¤ä½¿ç”¨ï¼‰ã€‚

- æŒ‰éœ€é…ç½®å¯†é’¥å‚æ•°ï¼š
  - **Expiry**ï¼šè®¾ç½®å¯†é’¥æœ‰æ•ˆæœŸï¼ˆå¦‚ 1 å°æ—¶ã€7 å¤©ï¼‰ã€‚
  - **Ephemeral**ï¼š"ä¸´æ—¶èŠ‚ç‚¹"ï¼Œç¦»çº¿åè‡ªåŠ¨ä»ç½‘ç»œä¸­ç§»é™¤ã€‚
  - **Tags**ï¼šç»™è®¾å¤‡æ·»åŠ æ ‡ç­¾ï¼ˆç”¨äºæƒé™æ§åˆ¶ï¼Œå¦‚ `tag:server`ï¼‰ã€‚

- ç”Ÿæˆåï¼Œç«‹å³å¤åˆ¶å¯†é’¥ã€‚

#### 2.2.2 åŠ å…¥ç½‘ç»œ

æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥ä½¿ç”¨ AuthKey åŠ å…¥ç½‘ç»œï¼š

**æ–¹å¼ä¸€ï¼šä½¿ç”¨ `up` å‘½ä»¤ï¼ˆæ¨èï¼‰**

```bash
sudo tailscale up --authkey=tskey-auth-xxxxxx-yyyyyy
```

**æ–¹å¼äºŒï¼šä½¿ç”¨ `login` å‘½ä»¤**

```bash
sudo tailscale login --authkey=tskey-auth-xxxxxx-yyyyyy
```

#### 2.2.3 é…ç½®éªŒè¯

   ```bash
   # æ§åˆ¶å°çš„Machinesé¡µé¢ï¼Œä¼šå‡ºç°è¯¥è®¾å¤‡çš„åç§°å’ŒçŠ¶æ€ï¼ˆåœ¨çº¿/ç¦»çº¿ï¼‰
   tailscale ip
   ```

   

<br/>



## ğŸ“™ ä¸‰. åŸºæœ¬å‘½ä»¤

### 3.1 å¸¸ç”¨å‘½ä»¤

**æŸ¥çœ‹è®¾å¤‡çŠ¶æ€**ï¼š
```bash
tailscale status
```

**è·å–è®¾å¤‡ç§æœ‰ IP**ï¼š
```bash
tailscale ip
```

**æ–­å¼€è¿æ¥**ï¼š
```bash
sudo tailscale down
```

**é‡æ–°è¿æ¥**ï¼š
```bash
sudo tailscale up
```

**é€€å‡ºç™»å½•**ï¼š
```bash
sudo tailscale logout
```

**æŸ¥çœ‹è¯¦ç»†çŠ¶æ€**ï¼š
```bash
tailscale status --json
```

**æŸ¥çœ‹ç½‘ç»œæ‹“æ‰‘**ï¼š
```bash
tailscale netcheck
```

### 3.2 é«˜çº§å‘½ä»¤

**SSH è¿æ¥åˆ°å…¶ä»–è®¾å¤‡**ï¼ˆå¦‚æœå¯ç”¨äº† SSH åŠŸèƒ½ï¼‰ï¼š
```bash
ssh <user>@<device>.tailnode.net
```

**æ–‡ä»¶ä¼ è¾“**ï¼š

```bash
# å‘é€æ–‡ä»¶åˆ°å…¶ä»–è®¾å¤‡
tailscale file cp file.txt <user>@<device>.tailnode.net:~

# æ¥æ”¶æ¥è‡ªå…¶ä»–è®¾å¤‡çš„æ–‡ä»¶
tailscale file cp <user>@<device>.tailnode.net:~/file.txt ./
```

**ç«¯å£è½¬å‘**ï¼š

```bash
# å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ° Tailscale ç½‘ç»œä¸­çš„å…¶ä»–è®¾å¤‡
tailscale serve tcp:3000 tcp://100.x.x.x:3000
```



<br/>



## ğŸ› ï¸ å››. åº”ç”¨æ¡ˆä¾‹

### 4.1 Webå®‰å…¨è®¿é—®

**åœºæ™¯**ï¼šæŸä¸ªWeb åº”ç”¨ï¼Œä¸»ç«™ä½¿ç”¨å¤–ç½‘è®¿é—®ï¼ŒAdminç®¡ç†åå°ä½¿ç”¨ Tailscaleå†…ç½‘è®¿é—®ï¼ˆéš”ç¦»å¤–ç½‘ï¼‰ï¼ŒNginxå»ºè®®é…ç½®å¦‚ï¼š

```nginx
server {
    listen 80;
    server_name example.com;

    # Webä¸»ç«™(å¤–ç½‘è®¿é—®)
    location / {
        root html;
        index index.html index.htm;
    }

    # Adminå¹³å°(å†…ç½‘è®¿é—®)
    location ^~ /admin {
        #root D:/wwwroot;  			# rootæ˜¯è·¯å¾„æ‹¼æ¥  
        alias D:/wwwroot/admin;		# aliasæ˜¯è·¯å¾„æ›¿æ¢
        index index.html index.htm;
        
        allow 127.0.0.1;            # localhost
        allow 172.16.0.0/12;        # 172å†…ç½‘æ®µ (172.16.0.0 - 172.31.255.255)
        allow 192.168.0.0/16;       # 192å†…ç½‘æ®µ (192.168.0.0 - 192.168.255.255)
        allow 100.64.0.0/10;        # è¿è¥å•†çº§NATä¿ç•™åœ°å€æ®µ(100.64.0.0 - 100.127.255.255)
        deny all; 
    }
}
```

### 4.2 é˜²ç«å¢™é…ç½®

è‹¥æƒ³æ›´è´´è¿‘çœŸå®åœºæ™¯ï¼ˆæœåŠ¡å™¨çš„ 8080 ç«¯å£ä¸å…è®¸"å…¬ç½‘"è®¿é—®ï¼Œä½†å…è®¸ Tailscale è®¿é—®ï¼‰ï¼š
- åœ¨æœåŠ¡å™¨ä¸­è®¾ç½®é˜²ç«å¢™ï¼Œç¦æ­¢ 8080 ç«¯å£è¢«"é Tailscale ç½‘ç»œ"è®¿é—®ï¼ˆä»¥ Ubuntu çš„ UFW ä¸ºä¾‹ï¼‰ï¼š
  ```bash
  # å…è®¸ Tailscale ç½‘æ®µï¼ˆ100.64.0.0/10ï¼‰è®¿é—® 8080 ç«¯å£
  sudo ufw allow in from 100.64.0.0/10 to any port 8080
  
  # ç¦æ­¢å…¶ä»–æ‰€æœ‰æ¥æºè®¿é—® 8080 ç«¯å£
  sudo ufw deny 8080
  ```
- æ­¤æ—¶ï¼Œå¤–éƒ¨è‹¥é€šè¿‡æœåŠ¡å™¨çš„"å…¬ç½‘ IP"è®¿é—® `å…¬ç½‘IP:8080` ä¼šè¢«æ‹’ç»ï¼Œä½†é€šè¿‡ Tailscale IP `100.xxx.xxx.xxx:8080` ä»å¯æ­£å¸¸è®¿é—®ï¼Œå®Œç¾æ¨¡æ‹Ÿ"å…¬ç½‘ç«¯å£å°é—­ä½† Tailscale å¯è®¿é—®"çš„æ•ˆæœã€‚



<br/>




## ğŸ† äº”. å®‰å…¨å®è·µ

### 5.1 è®¿é—®æ§åˆ¶

> åœ¨ Tailscale æ§åˆ¶å°çš„ ACL è®¾ç½®ä¸­ï¼Œå¯ä»¥ç²¾ç¡®æ§åˆ¶å“ªäº›è®¾å¤‡å¯ä»¥è®¿é—®å“ªäº›æœåŠ¡ã€‚

- ç™»å½• Tailscale æ§åˆ¶å°

- è¿›å…¥**Settings â†’ ACL Policies**

- ç¼–è¾‘æˆ–ç²˜è´´ä¸Šè¿°ACLç­–ç•¥

- ç‚¹å‡» Save ä¿å­˜é…ç½®

```json
{
  "acls": [
    {
      "action": "accept",
      "src": ["tag:server"],
      "dst": ["tag:database:5432,3306"]
    }
  ]
}
```


### 5.2 æ ‡ç­¾ç®¡ç†

ä¸ºä¸åŒç±»å‹çš„è®¾å¤‡åˆ†é…æ ‡ç­¾ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†ï¼ˆéœ€è¦åœ¨Auth Keyä¸­é¢„è®¾ï¼‰ï¼š
- `tag:server` - æœåŠ¡å™¨ç±»è®¾å¤‡
- `tag:database` - æ•°æ®åº“ç±»è®¾å¤‡
- `tag:admin` - ç®¡ç†å‘˜è®¾å¤‡
- `tag:employee` - å‘˜å·¥è®¾å¤‡

**è®¾ç½®æ ‡ç­¾çš„Auth Key**ï¼š

```bash
# åˆ›å»ºå¸¦æ ‡ç­¾çš„Auth Key
#!/bin/bash

# é¦–æ¬¡è®¤è¯å…¥ç½‘ + å®£å‘Šå•æ ‡ç­¾ï¼ˆéœ€å¯†é’¥ï¼‰
sudo tailscale up --authkey=tskey-xxx --advertise-tags=tag:server

# é‡ç½®æ‰€æœ‰é…ç½® + é‡æ–°å®£å‘Šå•æ ‡ç­¾ï¼ˆæ— å¯†é’¥ï¼Œé…ç½®å¼‚å¸¸æ—¶ç”¨ï¼‰
sudo tailscale up --reset --advertise-tags=tag:server

# å·²æœ‰è®¤è¯ä¸‹ï¼Œå®£å‘Šå¤šä¸ªæ ‡ç­¾ï¼ˆä»…æ”¹æ ‡ç­¾ï¼Œæ— é‡ç½®/è®¤è¯ï¼‰
sudo tailscale up --advertise-tags=tag:server,tag:prod

# æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ï¼ˆåŒ…å«Tagä¿¡æ¯ï¼‰
tailscale status

# ç§»é™¤Tag
sudo tailscale up --advertise-tags= "" --reset
```

### 5.3 å®‰å…¨æ¸…å•

- å®šæœŸæ£€æŸ¥å·²æˆæƒè®¾å¤‡ï¼ˆæ§åˆ¶å° Machines é¡µé¢ï¼‰

- ç”Ÿäº§æœåŠ¡å™¨ä½¿ç”¨ä¸€æ¬¡æ€§Auth Keyç™»å½•

- ä¸ºæ•æ„ŸæœåŠ¡è®¾ç½®ACLè®¿é—®ç­–ç•¥

- å®šæœŸè½®æ¢Auth Keyï¼ˆå»ºè®®æ¯90å¤©ï¼‰

- å¯ç”¨2FAä¿æŠ¤è´¦æˆ·å®‰å…¨

- å…³é—­ä¸å¿…è¦çš„æœåŠ¡ç«¯å£æš´éœ²




<br/>



## ğŸ“š å…­. å¸¸è§é—®é¢˜

**Q: è®¾å¤‡æ— æ³•è¿æ¥åˆ° Tailscale ç½‘ç»œæ€ä¹ˆåŠï¼Ÿ**
A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

- ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œèƒ½å¤Ÿè®¿é—®äº’è”ç½‘

- ç¡®è®¤ Tailscale æœåŠ¡æ­£åœ¨è¿è¡Œï¼š`sudo systemctl status tailscaled`

- é‡å¯ Tailscaleï¼š`sudo tailscale down` ç„¶å `sudo tailscale up`

**Q: æ— æ³•é€šè¿‡ Tailscale IP è®¿é—®æœåŠ¡ï¼Ÿ**
A: æ£€æŸ¥ï¼š

- ä¸¤ç«¯è®¾å¤‡æ˜¯å¦åœ¨åŒä¸€ Tailscale ç½‘ç»œä¸­

- é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†ç›¸åº”ç«¯å£çš„è®¿é—®

- æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œå¹¶ç›‘å¬æ­£ç¡®çš„åœ°å€



<br/>



## å‚è€ƒè¿æ¥

- https://tailscale.com


将 Docker 部署的 GitLab 迁移到另一台服务器，核心是 **“迁移数据卷+保持配置一致”**（GitLab 的所有项目、用户、配置都存储在 3 个数据卷中），全程无需额外安装复杂工具，步骤清晰可复现。以下是详细迁移流程：


### 一、迁移前准备（关键！避免踩坑）
1. **两台服务器环境要求**：
   - 目标服务器需安装与原服务器相同或更高版本的 Docker（`docker -v` 验证）；
   - 目标服务器需预留足够磁盘空间（至少比原服务器 `/var/gitlab/` 目录大 20%，用 `du -sh /var/gitlab/` 查看原目录大小）；
   - 迁移期间建议暂停 GitLab 写入（比如通知团队暂时不提交代码、不创建项目），避免数据不一致。

2. **工具准备**：
   - 原服务器和目标服务器需能通过 `scp` 或 `rsync` 传输文件（确保 SSH 端口互通，默认 22 或你自定义的端口）；
   - 若服务器之间无法直接通信，可先将数据打包到本地，再上传到目标服务器。


### 二、迁移步骤（分 4 步走，原服务器→目标服务器）
#### 步骤 1：原服务器操作 - 停止 GitLab 并备份数据卷
首先停止原 GitLab 容器，确保数据写入完成，再打包 3 个核心数据卷（`config`、`logs`、`data`）。

1. 停止原 GitLab 容器：
   ```bash
   # 停止容器（确保数据刷盘）
   sudo docker stop gitlab
   # 禁止容器自动重启（避免迁移期间意外启动）
   sudo docker update --restart=no gitlab
   ```

2. 打包数据卷目录（推荐 `tar` 打包，方便传输）：
   原服务器的数据卷挂载在 `/var/gitlab/` 下，直接打包整个目录：
   ```bash
   # 切换到数据卷父目录（避免打包路径冗余）
   cd /var
   # 打包 3 个数据卷（--exclude 跳过临时文件，加快打包速度）
   sudo tar -zcvf gitlab-backup.tar.gz \
     --exclude='gitlab/logs/*.log' \
     --exclude='gitlab/data/tmp' \
     gitlab/
   ```
   - 打包完成后，当前目录（`/var/`）会生成 `gitlab-backup.tar.gz` 文件（大小约等于原 `/var/gitlab/` 目录大小）。

3. 查看原 GitLab 镜像版本（目标服务器需使用相同版本，避免兼容性问题）：
   ```bash
   docker images | grep gitlab/gitlab-ce
   # 输出示例：gitlab/gitlab-ce   latest    xxxxxxxx   2 weeks ago   2.1GB
   # 记录版本标签（这里是 latest，若原镜像指定了具体版本如 16.9.0-ce.0，需记住）
   ```


#### 步骤 2：传输备份包到目标服务器
将原服务器的 `gitlab-backup.tar.gz` 传输到目标服务器的 `/var/` 目录（路径保持一致，方便后续解压）。

##### 方式 1：服务器直接通信（推荐，速度快）
在原服务器执行 `scp` 命令（替换 `目标服务器IP` 为实际 IP，若 SSH 端口不是 22，需加 `-P 端口号`）：
```bash
# 格式：scp 原文件路径 目标服务器用户@目标IP:目标路径
sudo scp /var/gitlab-backup.tar.gz root@目标服务器IP:/var/
```
- 输入目标服务器密码后，开始传输（大文件建议用 `rsync` 替代 `scp`，支持断点续传：`sudo rsync -avz /var/gitlab/ root@目标服务器IP:/var/gitlab/`）。

##### 方式 2：通过本地中转（服务器无法直接通信）
1. 原服务器将备份包下载到本地电脑（以 Windows 为例，用 Git Bash 或 Xshell）：
   ```bash
   scp root@原服务器IP:/var/gitlab-backup.tar.gz C:\本地目录\
   ```
2. 本地电脑将备份包上传到目标服务器：
   ```bash
   scp C:\本地目录\gitlab-backup.tar.gz root@目标服务器IP:/var/
   ```


#### 步骤 3：目标服务器操作 - 解压备份并准备环境
1. 登录目标服务器，先创建与原服务器一致的目录结构（确保 Docker 挂载路径相同）：
   ```bash
   sudo mkdir -p /var/gitlab/{config,logs,data}
   ```

2. 解压备份包到 `/var/` 目录（覆盖刚创建的 `gitlab/` 目录）：
   ```bash
   cd /var
   # 解压（-z 解压 gzip 格式，-x 提取文件，-v 显示进度，-f 指定备份包）
   sudo tar -zxvf gitlab-backup.tar.gz
   ```
   - 解压完成后，`/var/gitlab/` 目录会包含原服务器的所有配置、数据和日志（权限自动保留）。

3. 拉取与原服务器相同版本的 GitLab 镜像（避免版本差异导致数据不兼容）：
   ```bash
   # 若原服务器是 latest 版本，直接拉取：
   sudo docker pull gitlab/gitlab-ce:latest
   # 若原服务器是具体版本（如 16.9.0-ce.0），替换为对应版本：
   # sudo docker pull gitlab/gitlab-ce:16.9.0-ce.0
   ```


#### 步骤 4：目标服务器操作 - 启动 GitLab 并验证
使用与原服务器 **完全相同的 `docker run` 命令** 启动容器（确保端口、挂载路径、容器名一致，仅 hostname 可按需修改）。

1. 启动 GitLab 容器（直接复用原命令，无需修改）：
   ```bash
   sudo docker run --detach \
     --hostname git.mafool.com \  # 若目标服务器域名变更，可修改此处（需后续同步 Git 远程地址）
     --publish 9043:443 \
     --publish 9080:80 \
     --publish 9022:22 \
     --name gitlab \
     --restart always \
     --volume /var/gitlab/config:/etc/gitlab \
     --volume /var/gitlab/logs:/var/log/gitlab \
     --volume /var/gitlab/data:/var/opt/gitlab \
     gitlab/gitlab-ce:latest  # 确保版本与原服务器一致
   ```

2. 等待 GitLab 初始化（首次启动时间较长，约 5-15 分钟，取决于服务器配置）：
   - 查看启动日志，确认无报错：
     ```bash
     sudo docker logs -f gitlab
     ```
   - 当日志出现 `gitlab Reconfigured!` 或 `nginx: [info] start worker processes` 时，说明启动成功。

3. 验证迁移结果：
   - 浏览器访问目标服务器的 GitLab 地址：`http://目标服务器IP:9080` 或 `https://目标服务器IP:9043`；
   - 登录原 GitLab 的管理员账号（用户名/密码不变），检查：
     1. 所有项目是否存在（包括代码、分支、标签）；
     2. 用户、组、权限是否正常；
     3. 尝试克隆一个项目（用目标服务器的地址），测试提交/推送是否正常。


### 三、关键补充（避免迁移后踩坑）
#### 1. 若目标服务器域名/IP 变更（必看！）
如果目标服务器的域名（如 `git.mafool.com`）或 IP 变了，需做两件事：
- ① 修改 GitLab 内部配置（确保系统内链接正常）：
  1. 进入目标服务器的 GitLab 容器：
     ```bash
     sudo docker exec -it gitlab bash
     ```
  2. 编辑 GitLab 配置文件：
     ```bash
     vi /etc/gitlab/gitlab.rb
     ```
  3. 修改以下参数（替换为目标服务器的域名/IP）：
     ```ruby
     external_url 'http://目标IP:9080'  # 或 https://git.新域名.com:9043
     gitlab_rails['gitlab_ssh_host'] = '目标IP'  # SSH 克隆时的主机名
     gitlab_rails['gitlab_shell_ssh_port'] = 9022  # 保持与 docker run 映射的 9022 端口一致
     ```
  4. 重新配置 GitLab 并重启服务：
     ```bash
     gitlab-ctl reconfigure
     gitlab-ctl restart
     exit  # 退出容器
     ```

- ② 通知团队更新本地 Git 远程地址：
  本地仓库需替换远程链接中的旧 IP/域名，示例：
  ```bash
  # 查看当前远程地址
  git remote -v
  # 替换为新地址（HTTP 方式）
  git remote set-url origin http://目标IP:9080/用户名/项目名.git
  # 或 SSH 方式（需确保本地 SSH 密钥已添加到目标 GitLab）
  git remote set-url origin ssh://git@目标IP:9022/用户名/项目名.git
  ```

#### 2. 迁移后异常处理
- 若启动后访问 502：大概率是初始化未完成，继续等待 5-10 分钟，或查看日志 `docker logs -f gitlab` 排查报错（如端口占用、磁盘空间不足）；
- 若项目缺失或权限异常：检查 `/var/gitlab/data/` 目录权限是否为 `root:root`（Docker 挂载默认权限），可执行 `sudo chown -R root:root /var/gitlab/` 修复；
- 若 SSH 克隆失败：确认目标服务器 9022 端口已开放（`sudo ufw allow 9022/tcp`），且 `gitlab.rb` 中 `gitlab_shell_ssh_port` 配置正确。

#### 3. 原服务器后续处理
迁移验证无误后，原服务器的 GitLab 可停止并清理（避免误操作）：
```bash
# 停止并删除原容器
sudo docker stop gitlab && sudo docker rm gitlab
# 可选：删除原数据卷（确认无需备份后执行）
sudo rm -rf /var/gitlab/
sudo rm /var/gitlab-backup.tar.gz
```


### 总结
迁移的核心是 **“完整复制 3 个数据卷+保持配置/版本一致”**，全程无需导出/导入项目，直接迁移数据卷即可保留所有信息。只要确保数据传输完整、启动命令一致，迁移成功率接近 100%。如果服务器之间网络带宽小，建议用 `rsync` 断点续传，或分卷打包备份。
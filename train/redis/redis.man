#!/bin/bash

DEFAULT_VERSION=6.2.5                                    # é»˜è®¤ç‰ˆæœ¬å·
STABLE_VERSION=""                                        # ç¨³å®šç‰ˆæœ¬å·
CURRENT_VERSION=""                                       # å½“å‰ç‰ˆæœ¬å·
INSTALL_PATH=/usr/local/redis                            # æœåŠ¡å®‰è£…è·¯å¾„
STABLE_URL=https://download.redis.io/redis-stable.tar.gz # ç¨³å®šç‰ˆä¸‹è½½åœ°å€

#============================================================================
ERROR=" ğŸš« "
SUCCESS=" âœ… "
WARN=" âš ï¸  "
INFO=" ğŸ“¢ "
RED="\033[31m"    # Error message
GREEN="\033[32m"  # Success message
YELLOW="\033[33m" # Warning message
BLUE="\033[36m"   # Info message
RESET='\033[0m'

# æ‰“å°å—(éœ€æ‰‹åŠ¨RESET)
echoBlock() {
    echo -e "${1}${@:2}"
}
# echoBlock "hello ${GREEN}world ${RESET}"

# æ‰“å°è¡Œ
echoLine() {
    echo -e "${1}${@:2}${RESET}" 1>&2
}
# echoLine ${RED} "ä¸åŠ å¼•å·"
# echoLine "${INFO}" "å»ºè®®åŠ å¼•å·"
# echoLine "${GREEN}å»ºè®®å†…å®¹è¿æ¥"
# echoLine "ğŸ‘æ”¯æŒ ${RED}ğŸ˜„Emoji"

#============================================================================

# å®‰è£…Makeä¾èµ–
makeRely() {
    yum install -y gcc-c++
    yum install -y pcre pcre-devel
    yum install -y zlib zlib-devel
    yum install -y openssl openssl-devel
}

# å·²å®‰è£…çš„ç‰ˆæœ¬
currentVersion() {
    TMP_VERSION=$(redis-server --version 2>/dev/null)
    if [[ $? != 0 ]]; then
        echoLine "${RED}${ERROR}å½“å‰ç³»ç»Ÿæœªå‘ç°RedisæœåŠ¡"
        return 1
    fi
    CURRENT_VERSION=$(echo "${TMP_VERSION}" | awk '{print $3}' | grep -o '[0-9]\.[0-9]\.[0-9]')
}

# æœ€æ–°Stableç‰ˆæœ¬å·
stableVersion() {
    stable_url=https://download.redis.io/redis-stable/src/version.h
    STABLE_VERSION=$(curl -sSL ${stable_url} | grep -o '[0-9]\.[0-9]\.[0-9]')
    if [[ ${STABLE_VERSION} == "" ]]; then
        echoLine "${RED}${ERROR}è·å–stableç‰ˆæœ¬å·å¼‚å¸¸:${stable_url}"
        return 1
    fi
}

# æ·»åŠ Pathå˜é‡
appandPath() {
    if [[ $(env | grep ${INSTALL_PATH}) == "" ]]; then
        echo "export PATH=${INSTALL_PATH}/bin:\$PATH" >>/etc/profile
        if [[ $? == 0 ]]; then
            trap "source /etc/profile   #å›è½¦åˆ·æ–°ç¯å¢ƒå˜é‡" EXIT
            echoLine ${BLUE} "å·²é™„åŠ Pathå˜é‡"
            #/bin/bash source /etc/profile
            return 0
        fi
        echoLine ${YELLOW} "æ·»åŠ Pathå˜é‡å¤±è´¥"
        exit 1
    else
        echoLine "${WARN}${YEEELOW}Pathå˜é‡å·²å­˜åœ¨"
    fi
}

# CPUæ¶æ„
archAffix() {
    case "$(uname -m)" in
    i686 | i386) echo '32' ;;
    x86_64 | amd64) echo '64' ;;
    armv5tel) echo 'arm32-v5' ;;
    armv6l) echo 'arm32-v6' ;;
    armv7 | armv7l) echo 'arm32-v7a' ;;
    armv8 | aarch64) echo 'arm64-v8a' ;;
    mips64le) echo 'mips64le' ;;
    mips64) echo 'mips64' ;;
    mipsle) echo 'mips32le' ;;
    mips) echo 'mips32' ;;
    ppc64le) echo 'ppc64le' ;;
    ppc64) echo 'ppc64' ;;
    riscv64) echo 'riscv64' ;;
    s390x) echo 's390x' ;;
    *) colorEcho $RED " ä¸æ”¯æŒå½“å‰CPUæ¶æ„ï¼" exit 1 ;;
    esac
    return 0
}

help() {
    echo "Usage:"
}

main() {
    # archAffix
    currentVersion
    if [[ $? == 0 ]]; then
        echoBlock "${SUCCESS}å·²å®‰è£…ç‰ˆæœ¬: ${BLUE}${CURRENT_VERSION}${RESET}"
    fi

    stableVersion
    if [[ $? == 0 ]]; then
        echoBlock "${INFO}æœ€æ–°Stableç‰ˆæœ¬: ${BLUE}${STABLE_VERSION}${RESET}"
    fi

    appandPath

    echoLine "${BLUE}================= Done ! =================\n"
}
main
